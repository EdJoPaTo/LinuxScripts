#!/usr/bin/env bash
set -eu

# usage: remoterun server command which should be executed
# usage: remoterun my.server.tld cargo build

exclude=${REMOTERUN_EXCLUDE:-"--exclude=.git --exclude-from=.gitignore"}

server=$1
shift 1
command=$*

folder=${PWD##*/}
remotefolder=".cache/remoterun/$folder/"

# remotefunc is called on the remote host with one argument: the command to be run
remotefunc() {
	command=$1
	bash -cl -- "set -x && $command"
	exitcode=$?
	uptime
	exit $exitcode
}

rsync \
	--recursive --links --copy-unsafe-links --perms --times --omit-dir-times \
	--compress --verbose --checksum \
	--delete-delay \
	$exclude \
	--rsync-path="mkdir -p $remotefolder && rsync" \
	. "$server:$remotefolder"
ssh -tt "$server" "uptime && cd '$remotefolder' && $(declare -f remotefunc) && remotefunc '$command'"
