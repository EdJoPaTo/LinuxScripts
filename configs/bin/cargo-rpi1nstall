#!/usr/bin/env sh

# When used as a cargo subcommand the first argument is the subcommand which should be removed
[ "$1" = "rpi1nstall" ] && shift 1

set -eu

server=$1

TARGET=arm-unknown-linux-gnueabihf

cross build --release --target $TARGET
debpath=$(cargo deb --no-build --no-strip --target $TARGET)

debname=$(basename "$debpath")

rsync \
	--copy-links --times \
	--checksum \
	--info=progress2 \
	"$debpath" "$server:/tmp/$debname"

ssh -l root "$server" -- dpkg --force-bad-verify -i "/tmp/$debname"

ssh "$server" -- rm "/tmp/$debname"
