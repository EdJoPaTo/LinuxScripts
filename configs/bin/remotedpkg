#!/usr/bin/env bash
set -eu

# usage: remotedpkg server

# sends all *.deb files to the server and uses `sudo dpkg -i bla.deb` on them

server=$1

remotefunc() {
	sudo bash -c 'cd /tmp/remotedpkg; set -eu; for p in *.deb; do dpkg -i "$p"; done'
	exitcode=$?
	rm -rf /tmp/remotedpkg
	uptime
	exit $exitcode
}

rsync \
	--copy-links --times \
	--compress --checksum \
	--info=progress2 \
	--rsync-path="mkdir -p /tmp/remotedpkg && rsync" \
	./*.deb "$server:/tmp/remotedpkg"
ssh -tt "$server" \
	"uptime && $(declare -f remotefunc) && remotefunc"
