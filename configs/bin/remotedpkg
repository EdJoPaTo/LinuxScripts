#!/usr/bin/env bash
set -eu -o pipefail

# usage: remotedpkg server

# sends all *.deb files to the server and uses `sudo dpkg -i bla.deb` on them

server=$1

rsync \
	--copy-links --times \
	--compress --checksum \
	--info=progress2 \
	--rsync-path="mkdir -p /tmp/remotedpkg && rsync" \
	./*.deb "$server:/tmp/remotedpkg"

for p in ./*.deb; do
	ssh -l root "$server" -- dpkg --force-bad-verify -i "/tmp/remotedpkg/$p"
done

ssh "$server" -- rm -rf /tmp/remotedpkg
